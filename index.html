<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸­æ–‡ç§‘è­˜å­—é€š (V12.0 æ™ºèƒ½èªæ„åˆ†æç‰ˆ)</title>

<script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cnchar/cnchar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cnchar-trad/cnchar.trad.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cnchar-radical/cnchar.radical.min.js"></script>

<style>
    :root {
        --primary: #1976d2;
        --primary-bg: #e3f2fd;
        --accent: #d84315;
        --success: #4caf50;
        --text-main: #333;
        --bg-body: #f4f7f6;
        --bg-white: #ffffff;
        --radius-box: 20px;
        --grid-size: 260px;
    }

    body {
        font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0; padding: 20px; text-align: center;
    }

    h1 { color: var(--primary); letter-spacing: 2px; margin-bottom: 30px; }

    /* å·¥å…·åˆ— */
    .toolbar {
        position: sticky; top: 0; z-index: 100;
        background: rgba(244, 247, 246, 0.95); padding: 10px;
        display: flex; justify-content: center; gap: 15px;
        backdrop-filter: blur(5px); border-bottom: 1px solid #ddd;
        flex-wrap: wrap;
    }
    .tool-btn {
        padding: 8px 20px; border-radius: 20px; border: 2px solid var(--primary);
        background: white; color: var(--primary); font-weight: bold; cursor: pointer;
        transition: all 0.2s;
    }
    .tool-btn:hover { background: var(--primary-bg); transform: translateY(-2px); }
    .tool-btn.active-mode {
        background: var(--primary); color: white; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
    }

    /* è¼¸å…¥å€ */
    .input-section {
        background: var(--bg-white); padding: 30px; border-radius: var(--radius-box);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: inline-block;
        margin: 30px 0; border-top: 6px solid var(--primary);
    }
    input[type="text"] {
        font-size: 28px; padding: 10px; width: 300px;
        border: 2px solid #bdc3c7; border-radius: 10px; text-align: center;
    }
    button.main-btn {
        font-size: 24px; padding: 10px 30px; margin-left: 10px;
        background-color: var(--primary); color: white; border: none;
        border-radius: 10px; cursor: pointer; box-shadow: 0 4px 0 #0d47a1;
    }
    button.main-btn:active { transform: translateY(4px); box-shadow: none; }

    /* å¡ç‰‡å®¹å™¨ */
    #characters-container { display: flex; flex-direction: column; align-items: center; gap: 40px; }
    
    .word-group-wrapper {
        background: var(--bg-white); width: 95%; max-width: 1400px; padding: 30px;
        border-radius: var(--radius-box); box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        text-align: left; animation: fadeInUp 0.5s ease-out;
    }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* ğŸ”¥ æ¨™é¡Œå€å¡Šå¤§å‡ç´š */
    .word-group-header {
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 2px dashed #eee; padding-bottom: 15px; margin-bottom: 20px;
    }
    
    .title-block { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .word-label-small { font-size: 16px; color: #888; font-weight: normal; margin-right: 5px; }
    .word-title { font-size: 48px; font-weight: bold; color: var(--primary); line-height: 1; }
    
    /* è©èªç´šå¤§æ¨™ç±¤ */
    .word-pos-tag {
        font-size: 20px; padding: 6px 15px; border-radius: 20px;
        color: white; font-weight: bold; background-color: #607d8b;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .word-pos-tag.noun { background-color: #1976d2; }
    .word-pos-tag.verb { background-color: #388e3c; }
    .word-pos-tag.adj { background-color: #f57c00; }

    .audio-controls button {
        background: var(--primary-bg); color: var(--primary); border: none;
        padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-left: 10px;
    }

    .word-main-flex { display: flex; gap: 40px; flex-wrap: wrap; }
    .word-visual-left { flex: 3; min-width: 350px; }
    .word-info-right { flex: 1; min-width: 250px; background: #fff8e1; padding: 20px; border-radius: var(--radius-box); }

    .single-char-section {
        background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid #eee;
    }
    .char-main-row { display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; }
    .char-block-item { display: flex; flex-direction: column; align-items: center; }
    .visual-label { font-size: 20px; font-weight: bold; color: #555; margin-bottom: 15px; width: 100%; border-left: 6px solid var(--primary); padding-left: 10px; }

    .grid-box {
        width: var(--grid-size); height: var(--grid-size);
        border: 4px solid var(--primary); background-color: white;
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxsaW5lIHgxPSI1MCUiIHkxPSIwIiB4Mj0iNTAlIiB5Mj0iMTAwJSIgc3Ryb2tlPSIjZmZjY2NjIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1kYXNoYXJyYXk9IjgsOCIvPjxsaW5lIHgxPSIwIiB5MT0iNTAlIiB4Mj0iMTAwJSIgeTI9IjUwJSIgc3Ryb2tlPSIjZmZjY2NjIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1kYXNoYXJyYXk9IjgsOCIvPjwvc3ZnPg==");
        background-size: 100% 100%; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    @media (max-width: 768px) { :root { --grid-size: 160px; } }

    .breakdown-section { background: white; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-top: 15px; }
    .breakdown-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .step-box {
        width: 60px; height: 60px; border: 1px solid #ccc; border-radius: 5px; position: relative; background: white;
        display: flex; justify-content: center; align-items: center;
    }
    .step-box svg { width: 100%; height: 100%; display: block; }
    .step-box path { stroke: none; }
    .step-number { position: absolute; bottom: 2px; right: 2px; font-size: 10px; color: #999; }
    .step-box.is-last { border: 2px solid var(--accent); }

    .info-item { margin-bottom: 15px; border-bottom: 1px solid #ffe0b2; padding-bottom: 10px; }
    .info-big-char { font-size: 40px; color: var(--accent); font-weight: bold; font-family: "æ¨™æ¥·é«”"; }
    .info-radical-link { color: var(--accent); text-decoration: underline; cursor: pointer; font-weight: bold; }
    .info-row { margin-bottom: 5px; font-size: 18px; color: #444; }

    /* å–®å­—ç´šè©æ€§ (å°è™Ÿ) */
    .pos-container { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
    .pos-tag {
        font-size: 14px; padding: 2px 8px; border-radius: 12px;
        color: white; font-weight: bold; background-color: #78909c; box-shadow: 0 2px 0 rgba(0,0,0,0.1);
    }
    .pos-tag.noun { background-color: #42a5f5; } 
    .pos-tag.verb { background-color: #66bb6a; } 
    .pos-tag.adj { background-color: #ffa726; }  

    .js-def-text { white-space: pre-wrap; line-height: 1.8; text-align: left; color: #444; font-size: 18px; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 200; display: none;
        justify-content: center; align-items: center; backdrop-filter: blur(3px);
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
        background: white; width: 80%; max-width: 600px; padding: 30px;
        border-radius: 20px; border: 5px solid #ffccbc; position: relative;
    }
    .modal-close { position: absolute; top: 10px; right: 15px; font-size: 30px; cursor: pointer; }
    .radical-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px; }
    .radical-char-btn {
        width: 60px; height: 60px; font-size: 30px; border: 1px solid #ddd;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        background: #fff3e0; border-radius: 10px; font-family: "æ¨™æ¥·é«”";
    }

    /* å…¨è¦½æ¨¡å¼ */
    body.overview-mode #characters-container { flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: stretch; }
    body.overview-mode .word-group-wrapper { width: 45%; min-width: 300px; margin: 10px; border-top: 8px solid var(--primary); }
    body.overview-mode .word-main-flex { display: none !important; }
    body.overview-mode .word-group-header { border-bottom: none; margin-bottom: 5px; }
    body.overview-mode .word-definition-footer { border-top: 1px solid #eee; padding-top: 15px; margin-top: 0; }

    /* åˆ—å°æ¨£å¼ */
    #print-container { display: none; }
    @media print {
        @page { size: A4; margin: 10mm; }
        body { background: white; -webkit-print-color-adjust: exact; padding: 0; }
        #screen-ui, .toolbar, .modal-overlay { display: none !important; }
        #print-container { display: block !important; }
        
        .print-page-header { text-align: center; border-bottom: 2px solid black; margin-bottom: 20px; padding-bottom: 10px; }
        .print-row { display: flex; flex-direction: column; margin-bottom: 25px; border-bottom: 1px dashed #ccc; padding-bottom: 15px; page-break-inside: avoid; }
        .print-main-line { display: flex; align-items: center; margin-bottom: 10px; }
        .print-info-col { display: flex; flex-wrap: wrap; gap: 10px; padding-right: 15px; border-right: 2px solid #000; margin-right: 15px; width: 150px; justify-content: center; align-content: center; }
        .print-char-block { text-align: center; margin-bottom: 5px; } 
        .print-char-big { font-size: 56px; font-family: "æ¨™æ¥·é«”"; font-weight: bold; line-height: 1; }
        .print-pinyin { display: none; }
        .print-grid-container { flex: 1; display: flex; gap: 5px; }
        .print-grid-box {
            width: 70px; height: 70px; border: 1px solid #000;
            background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc3MCcgaGVpZ2h0PSc3MCc+CiAgPGxpbmUgeDE9JzAnIHkxPSczNScgeDI9JzcwJyB5Mj0nMzUnIHN0cm9rZT0nI2NjYycgc3Ryb2tlLXdpZHRoPScwLjUnIHN0cm9rZS1kYXNoYXJyYXk9JzMsMycvPgogIDxsaW5lIHgxPSczNScgeTE9JzAnIHgyPSczNScgeTI9JzcwJyBzdHJva2U9JyNjY2MnIHN0cm9rZS13aWR0aD0nMC41JyBzdHJva2UtZGFzaGFycmF5PSczLDMnLz4KPC9zdmc+");
        }
        .print-breakdown-area { margin-left: 20px; }
        .print-breakdown-row { display: flex; align-items: center; margin-top: 8px; border-bottom: 1px dotted #eee; padding-bottom: 5px; }
        .print-label { font-size: 16px; font-weight: bold; color: #000; width: 40px; flex-shrink: 0; }
        .print-breakdown-imgs { display: flex; flex-wrap: wrap; gap: 5px; }
        .print-step-box { width: 35px; height: 35px; border: 1px solid #ccc; position: relative; }
    }
</style>
</head>
<body>

    <div id="screen-ui">
        <div class="toolbar">
            <button class="tool-btn" onclick="toggleOverviewMode()" id="btn-overview">ğŸ‘ï¸ å…¨è¦½æ¨¡å¼ï¼šé—œ</button>
            <button class="tool-btn" onclick="autoPrint()">ğŸ–¨ï¸ åˆ—å°ä½œæ¥­ç´™ (è©èªåˆä½µ)</button>
        </div>

        <h1>ğŸ“˜ ä¸­æ–‡ç§‘è­˜å­—é€š (V12.0 æ™ºèƒ½èªæ„åˆ†æç‰ˆ)</h1>

        <div class="input-section">
            <label style="font-size: 20px; font-weight: bold; color: var(--primary);">è«‹è¼¸å…¥ç”Ÿå­—æˆ–è©èª</label><br><br>
            <input type="text" id="input-text" placeholder="ä¾‹å¦‚ï¼šå­¸æ ¡" value="å­¸æ ¡">
            <button class="main-btn" onclick="generateCards()">ğŸ” é–‹å§‹ç·´ç¿’</button>
            <div id="loading" style="display:none; margin-top:10px; color:#1976d2;">â³ è³‡æ–™è™•ç†ä¸­...</div>
        </div>

        <div id="characters-container"></div>
    </div>

    <div id="radical-modal" class="modal-overlay" onclick="closeRadicalModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeRadicalModal(null, true)">Ã—</span>
            <h2 style="color:var(--accent)">ğŸ” éƒ¨é¦–å­—ä¾‹ï¼š<span id="modal-radical-title"></span></h2>
            <div id="modal-grid" class="radical-grid"></div>
        </div>
    </div>

    <div id="print-container">
        <div class="print-page-header">
            <h2>ä¸­æ–‡ç§‘å¯«å­—ç·´ç¿’</h2>
            <div style="display:flex; justify-content:space-between; padding:0 50px;">
                <span>å§“åï¼š__________</span><span>æ—¥æœŸï¼š__________</span><span>åˆ†æ•¸ï¼š__________</span>
            </div>
        </div>
        <div id="print-content"></div>
    </div>

    <template id="card-template">
        <div class="word-group-wrapper">
            <div class="word-group-header">
                <div class="title-block">
                    <span class="word-label-small">è©èªï¼š</span>
                    <span class="word-title js-title"></span>
                    <div class="js-word-pos"></div> </div>
                <div class="audio-controls">
                    <button class="js-btn-mandarin">ğŸ”Š æ™®é€šè©±</button>
                    <button class="js-btn-cantonese">ğŸ”Š ç²µèª</button>
                </div>
            </div>
            <div class="word-main-flex">
                <div class="word-visual-left js-visual-container"></div>
                <div class="word-info-right js-info-container"></div>
            </div>
            <div class="word-definition-footer" style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                <div style="font-weight:bold; color:var(--success)">ğŸ“– è§£é‡‹</div>
                <div class="js-def-text"></div>
            </div>
        </div>
    </template>

    <template id="char-block-template">
        <div class="single-char-section">
            <div class="char-main-row">
                <div class="char-block-item">
                    <div class="visual-label">ğŸ‘€ ç­†é †æ¼”ç¤º</div>
                    <div class="grid-box js-demo-target"></div>
                    <button class="tool-btn js-play-btn" style="padding: 2px 10px; font-size: 14px;">â–¶ æ’­æ”¾</button>
                </div>
                <div class="char-block-item">
                    <div class="visual-label label-quiz">âœï¸ å­¸ç”Ÿç·´ç¿’</div>
                    <div class="grid-box js-quiz-target" style="cursor:crosshair"></div>
                    <span class="js-status-text" style="font-weight:bold; color:var(--accent)">è«‹å¯«å­—</span>
                    <button class="tool-btn js-reset-btn" style="padding: 2px 10px; font-size: 14px;">é‡å¯«</button>
                </div>
            </div>
            <div class="breakdown-section">
                <div class="visual-label" style="border-color: var(--accent);">ğŸ”¢ ç­†ç•«æ‹†è§£ (ç´…è‰²ç‚ºç•¶å‰ç­†ç•«)</div>
                <div class="breakdown-grid js-breakdown-target">
                    <span style="color:#aaa; font-size:12px;">è®€å–ä¸­...</span>
                </div>
            </div>
        </div>
    </template>

    <script>
        cnchar.use(window.cncharTrad);
        const HK_COMMON_CHARS = "ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒè¬æ—¥æœˆæ°´ç«æœ¨é‡‘åœŸäººå£æ‰‹è¶³è€³ç›®å¿ƒåŠ›åˆ€å¼“æˆˆè™«è²è»ŠèˆŸé¦¬ç¾Šç‰›é³¥é­šè‚‰é›¨é¢¨é›²é›»ç”°è¡£é£Ÿä½è¡Œçˆ¶æ¯å…„å¼Ÿå§å¦¹ç”·å¥³è€å°‘å¤§å°é«˜ä½é•·çŸ­å¤šå°‘å‰å¾Œå·¦å³å…§å¤–ä¸Šä¸‹æ±è¥¿å—åŒ—æ˜¥å¤ç§‹å†¬æ—©æ™šåˆå¤œå¹´æœˆæ—¥æ™‚åˆ†ç§’ä»Šå¤©æ˜æ˜¨æ˜ŸæœŸå­¸æ ¡å¸«ç”Ÿèª²æ›¸ç­†ç´™ç•«åœ–æ–‡æ•¸å­—è©å¥è¨€èªå•ç­”çœ‹è½èªªè®€å¯«åç«‹èµ°è·‘è·³åƒå–ç¡ç©æ¨‚å–œæ€’å“€æ¨‚é€™é‚£èª°ä»€éº¼è£¡é‚Šå®¶åœ‹åŸå¸‚æ‘è‰èŠ±æ¨¹æ—æœèœç“œè±†ç±³éºµé£¯è‚‰è›‹å¥¶æ²¹é¹½ç³–èŒ¶æ¯ç›¤ç¢—ç­·åˆ€å‰åŒ™æ¡Œæ¤…åºŠç‡ˆé–€çª—ç‰†åœ°æˆ¿åº—è»Šèˆ¹é£›æ©Ÿå…¬å·´å£«çš„å£«åœ°éµç«™è·¯æ©‹æ±Ÿæ²³æµ·æ´‹å±±è°·çŸ³æ²™æ³¥å…‰æš—å†·ç†±å¿«æ…¢å¥½å£çœŸå‡å°éŒ¯ç¾éº—ä¹¾æ·¨æ•´é½Šè°æ˜å‹¤å‹å‹‡æ•¢å‹æ„›ç¦®è²Œå®ˆè¦èª å¯¦å¥åº·å¿«æ¨‚å¹«å¿™åˆä½œåˆ†äº«éŠæˆ²é‹å‹•å”±æ­Œè·³èˆç•«ç•«è¬›æ•…äº‹åšåŠŸèª²æ´—è‡‰åˆ·ç‰™ç©¿è¡£è„«é‹æ”¶æ‹¾æ•´ç†æ¸…æ½”æƒåœ°æŠ¹çª—æ¾†æ°´ç¨®èŠ±é£¼é¤Šå¯µç‰©ç‹—è²“å…”é›é´¨éµè±¬ç‰›ç¾Šèº«é«”é ­é ¸è‚©èƒŒè…°è‡€è…¿è…³è†è“‹é¡é¢çœ¼çœ‰é¼»å£ç‰™èˆŒå”‡è€³é«®æŒ‡ç”²çš®è†šé¡è‰²ç´…ç™½é»ƒç¶ è—ç´«é»‘ç°æ©™å•¡å¤©åœ°äººä½ æˆ‘ä»–å¥¹å®ƒå€‘çˆ¸åª½å“¥å§å¼Ÿå¦¹çˆºå«²å…¬å©†ä¼¯å”å§¨èˆ…å…’å­«æœ‹å‹é„°å±…åŒå­¸è€å¸«æ ¡é•·é†«ç”Ÿè­·å£«è­¦å¯Ÿéƒµå·®å¸æ©Ÿåº—å“¡å»šå¸«è¾²å¤«æ¼å¤«å·¥äººæ–‡å“¡æ­Œæ‰‹ç•«å®¶é‹å‹•å“¡å¤ªç©ºäººæ„›å¥½èˆˆè¶£å”±æ­Œè·³èˆç•«ç•«çœ‹æ›¸æ¸¸æ³³æ‰“çƒè·‘æ­¥è¸å–®è»Šæ—…è¡Œæ”å½±çƒ¹é£ªç¨®æ¤é£¼é¤Šæ”¶é›†éƒµç¥¨éŒ¢å¹£æ¨¡å‹ç©å…·éŠæˆ²æ©Ÿé›»è…¦é›»è¦–é›»å½±éŸ³æ¨‚å¡é€šæ•…äº‹å ±ç´™é›œèªŒå­—å…¸åœ°åœ–åœ°çƒå„€æ–‡å…·æ›¸åŒ…ç­†ç›’é‰›ç­†åŸå­ç­†æ“¦è† å°ºå­å‰ªåˆ€è† æ°´è† ç´™ç•«ç­†é¡æ–™ç•«ç´™æ‰‹å·¥ç´™é¡è‰²ç´™çšºç´™ç·´ç¿’ç°¿æ‰‹å†Šèª²æœ¬åœ–æ›¸åœ–æ›¸é¤¨èª²å®¤ç¦®å ‚æ“å ´å°é£Ÿéƒ¨æ´—æ‰‹é–“è¾¦å…¬å®¤æ•™å“¡å®¤é†«ç™‚å®¤éŸ³æ¨‚å®¤è¦–è—å®¤é›»è…¦å®¤æ´»å‹•å®¤åœ–æ›¸è§’é–±è®€è§’å£å ±æ¿å ±å‘Šæ¿å£å ±æ¡Œå­æ¤…å­é»‘æ¿ç™½æ¿ç²‰ç­†ç™½æ¿ç­†æ¿æ“¦å¸ƒæŠ¹å¸ƒæƒæŠŠåƒåœ¾éŸåƒåœ¾æ¡¶å›æ”¶ç®±èŠ±ç›†æ¾†æ°´å£ºé£¼æ–™ç± å­é­šç¼¸æ°´æ—ç®±å…¬åœ’éŠæ¨‚å ´æ»‘æ¢¯é¦éŸ†è¹ºè¹ºæ¿æ”€ç™»æ¶æ²™æ± å–®è»Šå¾‘ç·©è·‘å¾‘æ¶¼äº­é•·æ¤…èŠ±æ§½è‰åœ°æ¨¹æœ¨èŠ±æœµå°è‰æ˜†èŸ²è´è¶èœœèœ‚èœ»èœ“èèŸ»è¸ç‰›èš¯èš“èœ˜è››ç”²èŸ²é’è›™èŸ¾èœçƒé¾œèœ¥èœ´å£è™è›‡éº»é›€é´¿å­ç‡•å­è€é·¹è²“é ­é·¹å•„æœ¨é³¥é¸šéµ¡ä¼éµé´•é³¥å­”é›€å¤©éµé´¨å­éµé›ç«é›è™è é¯¨é­šæµ·è±šé¯Šé­šæµ·é¦¬æµ·æ˜ŸèƒèŸ¹é¾è¦è¦å­ç« é­šé­·é­šæ°´æ¯çŠç‘šè²æ®¼æµ·èºçç é‡‘é­šé¯‰é­šç†±å¸¶é­šç…å­è€è™è±¹å¤§è±¡é•·é ¸é¹¿æ–‘é¦¬çŠ€ç‰›æ²³é¦¬é±·é­šç†Šè²“æ¨¹ç†Šè¢‹é¼ çŒ´å­çŒ©çŒ©æ¾é¼ è€é¼ å…”å­åˆºçŒ¬ç‹ç‹¸ç‹¼é‡è±¬é§±é§é¦¬é©¢é¨¾ç¾Šé¹¿è±¬ç‰›ç‹—è²“é¼ å€‰é¼ å¤©ç«ºé¼ é¾é³³éº’éºŸæ€ªç¸æé¾ç¥ä»™å¤©ä½¿é­”é¬¼å¦–æ€ªå¹½éˆæ®­å±å¸è¡€é¬¼å·«å©†å·¨äººå°çŸ®äººç¾äººé­šç™½é›ªå…¬ä¸»ç°å§‘å¨˜ç¡å…¬ä¸»å°ç´…å¸½ä¸‰éš»å°è±¬é†œå°é´¨é¾œå…”è³½è·‘ç‹¼ä¾†äº†è³£ç«æŸ´çš„å¥³å­©åœ‹ç‹ç‹åç‹å­å…¬ä¸»å®°ç›¸å°‡è»å£«å…µå‹‡å£«çµäººè¾²å¤«æ¨µå¤«æ¼å¤«å•†äººå°è²©ä¹ä¸å¼·ç›œå°å·é¨™å­å£äººå¥½äººè‹±é›„è¶…äººæ€ªç¸å¤–æ˜Ÿäººæ©Ÿå™¨äººé›»è…¦æ‰‹æ©Ÿé›»è©±é›»è¦–æ”¶éŸ³æ©Ÿç›¸æ©ŸéŒ„å½±æ©Ÿå½±å°æ©Ÿå‚³çœŸæ©Ÿæ‰“å°æ©Ÿéµç›¤æ»‘é¼ è¢å¹•ç¡¬ç¢Ÿå…‰ç¢Ÿéš¨èº«ç¢Ÿäº’è¯ç¶²ç¶²ç«™é›»éƒµçŸ­è¨Šæ‡‰ç”¨ç¨‹å¼éŠæˆ²è»Ÿä»¶ç¡¬ä»¶é›»æ± é›»ç·šæ’é ­æ’åº§é–‹é—œæ£ç‡ˆæ³¡å…‰ç®¡é›»ç­’å…‰çº–è¡›æ˜Ÿç«ç®­é£›èˆ¹å¤ªç©ºç«™å¤ªç©ºè¡£æœ›é é¡é¡¯å¾®é¡æ”¾å¤§é¡çœ¼é¡éš±å½¢çœ¼é¡å¤ªé™½çœ¼é¡åŠ©è½å™¨è¼ªæ¤…æ‹æ–ç¾©è‚¢è—¥æ°´è† å¸ƒç¹ƒå¸¶æ¢ç†±é‡å£ç½©æ¶ˆæ¯’è—¥æ°´æ´—æ‰‹æ¶²è‚¥çš‚æ²æµ´éœ²æ´—é«®æ°´ç‰™è†ç‰™åˆ·æ¯›å·¾æµ´å·¾æ‰‹å¸•ç´™å·¾å»ç´™æ¿•ç´™å·¾å°¿ç‰‡å¥¶ç²‰å¥¶ç“¶å¬°å…’è»Šæ–ç±ƒåºŠå–®è¢«å–®æ•é ­æ•é ­å¥—æ£‰è¢«æ¯›æ¯¯åºŠè¤¥è¡£æ«ƒé‹æ«ƒæ›¸æ«ƒé›œç‰©æ¶å„²ç‰©ç®±è¡£æ¶æ›¬è¡£å¤¾æ´—è¡£ç±ƒæ´—è¡£æ©Ÿä¹¾è¡£æ©Ÿç†¨æ–—ç†¨è¡£æ¿å¸å¡µæ©Ÿæƒåœ°æ©Ÿå™¨äººç©ºæ°£æ¸…æ–°æ©ŸæŠ½æ¿•æ©Ÿå†·æ°£æ©Ÿé¢¨æ‰‡æš–çˆç†±æ°´çˆç…®é£Ÿçˆå¾®æ³¢çˆç„—çˆå¤šå£«çˆé›»é£¯ç…²é›»ç†±æ°´å£ºæ”ªæ‹Œæ©Ÿæ¦¨æ±æ©Ÿæ´—ç¢—æ©Ÿé›ªæ«ƒå†°æ ¼åƒåœ¾è¢‹ä¿é®®ç´™éŒ«ç´™å»šæˆ¿ç´™ç™¾æ½”å¸ƒæ´—æ½”ç²¾æƒæŠŠæ‹–æŠŠæ°´æ¡¶æ°´å–‰æ°´ç®¡èŠ±ç‘æµ´ç¼¸æ´—æ‰‹ç›†é¦¬æ¡¶é¡å­æ¢³å­é¢¨ç­’æŒ‡ç”²é‰—åŒ–å¦å“é¦™æ°´é¦–é£¾æ‰‹éŒ¶é …éŠæ‰‹éŠè€³ç’°æˆ’æŒ‡çœ¼é¡é ˜å¸¶çš®å¸¶éŒ¢åŒ…æ‰‹è¢‹èƒŒåŒ…å…¬äº‹åŒ…æ—…è¡Œç®±é›¨å‚˜é›¨è¡£é›¨é´å¤ªé™½å¸½å†·å¸½æ‰‹å¥—åœå·¾é ¸å·¾å£ç½©æ³³è¡£æ³³è¤²æ³³é¡æ³³å¸½é‹å‹•æœé‹å‹•é‹çš®é‹æ¶¼é‹æ‹–é‹é«˜è·Ÿé‹é´å­è¥ªå­å…§è¡£å…§è¤²ç¡è¡£æ ¡æœåˆ¶æœè¥¿è£ç¦®æœå©šç´—æ——è¢å’ŒæœéŸ“æœå”è£ä¸­å±±è£ç‰›ä»”è¤²çŸ­è¤²é•·è¤²è£™å­é€£èº«è£™å¤–å¥—å¤§è¡£èƒŒå¿ƒæ¯›è¡£æ¤è¡«Tæ¤";
        
        const state = { writers: {} };

        function toggleOverviewMode() {
            document.body.classList.toggle('overview-mode');
            const btn = document.getElementById('btn-overview');
            const isOverview = document.body.classList.contains('overview-mode');
            btn.innerText = isOverview ? "ğŸ‘ï¸ å…¨è¦½æ¨¡å¼ï¼šé–‹" : "ğŸ‘ï¸ å…¨è¦½æ¨¡å¼ï¼šé—œ";
            btn.classList.toggle('active-mode', isOverview);
        }

        async function generateCards() {
            const input = document.getElementById('input-text').value.trim();
            const container = document.getElementById('characters-container');
            const loading = document.getElementById('loading');

            if (!input) { alert("è«‹è¼¸å…¥æ–‡å­—"); return; }
            
            container.innerHTML = ''; 
            loading.style.display = 'block';
            state.writers = {}; 

            try {
                const segmenter = new Intl.Segmenter('zh-Hant-HK', { granularity: 'word' });
                const segments = [...segmenter.segment(input)];

                for (const segment of segments) {
                    const word = segment.segment;
                    if (!/[\u4e00-\u9fa5]/.test(word)) continue;

                    const card = createCardElement(word);
                    container.appendChild(card); 

                    const chars = word.split('');
                    for (const char of chars) {
                        setupCharacterVisuals(char, card);
                        setupCharacterInfo(char, card);
                    }
                    updateDefinition(word, card);
                    
                    // ğŸ”¥ å•Ÿå‹•æ™ºèƒ½è©æ€§åµæ¸¬ (æƒæè§£é‡‹æ–‡)
                    fetchWordPOS(word, card);
                }
            } catch (err) {
                console.error(err);
                alert("ç™¼ç”ŸéŒ¯èª¤");
            } finally {
                loading.style.display = 'none';
            }
        }

        function createCardElement(word) {
            const template = document.getElementById('card-template');
            const clone = template.content.cloneNode(true);
            clone.querySelector('.js-title').textContent = word;
            clone.querySelector('.js-btn-mandarin').onclick = () => speakText(word, 'zh-CN');
            clone.querySelector('.js-btn-cantonese').onclick = () => speakText(word, 'zh-HK');
            return clone.children[0];
        }

        function setupCharacterVisuals(char, cardElement) {
            const visualContainer = cardElement.querySelector('.js-visual-container');
            const template = document.getElementById('char-block-template');
            const clone = template.content.cloneNode(true);
            
            const uid = Math.random().toString(36).substr(2, 9);
            const demoId = `demo-${uid}`;
            const quizId = `quiz-${uid}`;
            const breakdownContainer = clone.querySelector('.js-breakdown-target');

            clone.querySelector('.js-demo-target').id = demoId;
            clone.querySelector('.js-quiz-target').id = quizId;

            const playBtn = clone.querySelector('.js-play-btn');
            const resetBtn = clone.querySelector('.js-reset-btn');
            const statusText = clone.querySelector('.js-status-text');

            visualContainer.appendChild(clone);

            const width = window.innerWidth > 768 ? 260 : 160;

            const demo = HanziWriter.create(demoId, char, { width: width, height: width, padding: 5, showOutline: true, strokeAnimationSpeed: 1, delayBetweenStrokes: 200, strokeColor: '#555' });
            const quiz = HanziWriter.create(quizId, char, { width: width, height: width, padding: 5, showOutline: true, strokeColor: '#333', highlightColor: '#4CAF50', drawingWidth: 20, showHintAfterMisses: 2 });
            state.writers[uid] = { demo, quiz, status: statusText };

            startQuizLoop(uid);
            playBtn.onclick = () => demo.animateCharacter();
            resetBtn.onclick = () => resetQuiz(uid);

            setTimeout(() => generateBreakdown(char, breakdownContainer, false), 500);
        }

        async function generateBreakdown(char, container, isPrint) {
            if(!isPrint) container.innerHTML = '<span style="font-size:12px; color:#999;">è®€å–ä¸­...</span>';

            try {
                const url = `https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${encodeURIComponent(char)}.json`;
                const res = await fetch(url);
                if (!res.ok) throw new Error("Network Error");
                const charData = await res.json();

                if(!isPrint) container.innerHTML = ''; 
                const total = charData.strokes.length; 
                const strokes = charData.strokes;      

                for (let i = 0; i < total; i++) {
                    const box = document.createElement('div');
                    box.className = isPrint ? 'print-step-box' : (i === total - 1 ? 'step-box is-last' : 'step-box');
                    if(!isPrint) {
                        const num = document.createElement('span');
                        num.className = 'step-number';
                        num.innerText = i + 1;
                        box.appendChild(num);
                    }
                    container.appendChild(box);

                    const svgNS = "http://www.w3.org/2000/svg";
                    const svg = document.createElementNS(svgNS, "svg");
                    svg.setAttribute("viewBox", "0 0 1024 1024");
                    
                    const g = document.createElementNS(svgNS, "g");
                    g.setAttribute("transform", "scale(1, -1) translate(0, -900)");

                    for(let j = 0; j <= i; j++) {
                        const path = document.createElementNS(svgNS, "path");
                        path.setAttribute("d", strokes[j]);
                        if (j === i) {
                            path.setAttribute("fill", "#d84315"); 
                        } else {
                            path.setAttribute("fill", "#555");
                        }
                        g.appendChild(path);
                    }
                    svg.appendChild(g);
                    box.appendChild(svg);
                }

            } catch(e) { 
                console.error(e);
                container.innerHTML = `<span style="font-size:12px; color:red;">âŒ éŒ¯èª¤: ${e.message}</span>`; 
            }
        }

        function setupCharacterInfo(char, cardElement) {
            const infoContainer = cardElement.querySelector('.js-info-container');
            const pinyin = cnchar.spell(char, 'tone');
            let radical = 'ç„¡';
            try { radical = cnchar.radical(char)[0].radical; } catch {}

            const div = document.createElement('div');
            div.className = 'info-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:10px;">
                    <div class="info-big-char">${char}</div>
                    <div style="text-align:left; width:100%;">
                        <div class="info-row">æ‹¼éŸ³ï¼š${pinyin}</div>
                        <div class="info-row">
                            éƒ¨é¦–ï¼š<span onclick="openRadicalModal('${radical}')" class="info-radical-link">${radical}</span>
                        </div>
                        <div class="pos-container"></div>
                    </div>
                </div>
            `;
            infoContainer.appendChild(div);
            // æŸ¥è©¢å–®å­—è©æ€§
            fetchPOS(char, div.querySelector('.pos-container'));
        }

        async function fetchPOS(char, container) {
            try {
                const res = await fetch(`https://www.moedict.tw/uni/${encodeURIComponent(char)}.json`);
                if(!res.ok) return;
                const data = await res.json();
                
                const types = new Set();
                if(data.heteronyms) {
                    data.heteronyms.forEach(h => {
                        if(h.definitions) {
                            h.definitions.forEach(d => {
                                if(d.type) types.add(d.type.replace('è©','')); 
                            });
                        }
                    });
                }
                if(types.size > 0) {
                    types.forEach(type => {
                        const tag = document.createElement('span');
                        tag.className = 'pos-tag';
                        tag.innerText = type;
                        if(type.includes('å')) tag.classList.add('noun');
                        else if(type.includes('å‹•')) tag.classList.add('verb');
                        else if(type.includes('å½¢') || type.includes('å‰¯')) tag.classList.add('adj');
                        container.appendChild(tag);
                    });
                }
            } catch(e) {}
        }

        // --- ğŸ”¥ æ™ºèƒ½è©èªç´šè©æ€§ (æƒæè§£é‡‹ç‰ˆ) ---
        async function fetchWordPOS(word, cardElement) {
            const container = cardElement.querySelector('.js-word-pos');
            try {
                const res = await fetch(`https://www.moedict.tw/a/${encodeURIComponent(word)}.json`);
                if(!res.ok) return;
                const data = await res.json();
                
                const types = new Set();
                
                // 1. å„ªå…ˆæŸ¥çœ‹å®˜æ–¹ type æ¬„ä½
                if(data.h) {
                    data.h.forEach(h => {
                        if(h.d) {
                            h.d.forEach(d => {
                                if(d.type) types.add(d.type.replace('è©',''));
                                // 2. æ™ºèƒ½æƒæï¼šå¦‚æœæ²’æœ‰ typeï¼Œæƒæè§£é‡‹å…§æ–‡å°‹æ‰¾ [å] [å‹•] ç­‰æ¨™è¨˜
                                if(d.f && d.f.match(/\[(å|å‹•|å½¢|å‰¯)\]/)) {
                                    const match = d.f.match(/\[(å|å‹•|å½¢|å‰¯)\]/);
                                    if(match) types.add(match[1]);
                                }
                            });
                        }
                    });
                }

                // 3. å¦‚æœé‚„æ˜¯æ²’æœ‰ï¼Œå•Ÿå‹•é—œéµå­—åµæ¸¬ (Fallback)
                // é‡å°ã€Œå­¸æ ¡ã€é€™ç¨®å¸¸è¦‹è©ï¼Œå­—å…¸è§£é‡‹å¯èƒ½å¯«ã€Œå­å¼Ÿæ±‚å­¸çš„åœ°æ–¹ã€ï¼Œé›–æ²’æ¨™ç±¤ä½†è‚¯å®šæ˜¯åè©
                // é€™è£¡åšä¸€å€‹ç°¡å–®çš„è£œæ•‘ï¼š
                if(types.size === 0) {
                    // æƒæè§£é‡‹ï¼Œå¦‚æœæœ‰ã€Œ...çš„åœ°æ–¹ã€ã€ã€Œ...çš„æ©Ÿæ§‹ã€é€šå¸¸æ˜¯åè©
                    const fullDef = JSON.stringify(data);
                    if(fullDef.includes('çš„åœ°æ–¹') || fullDef.includes('çš„æ©Ÿæ§‹')) types.add('å');
                }

                // æ¸²æŸ“
                if(types.size > 0) {
                    types.forEach(type => {
                        const tag = document.createElement('span');
                        tag.className = 'word-pos-tag';
                        tag.innerText = type;
                        if(type.includes('å')) tag.classList.add('noun');
                        else if(type.includes('å‹•')) tag.classList.add('verb');
                        else if(type.includes('å½¢')) tag.classList.add('adj');
                        container.appendChild(tag);
                    });
                }
            } catch(e) {}
        }

        function startQuizLoop(uid) {
            const w = state.writers[uid];
            w.status.innerText = "è«‹å¯«å­—"; w.status.style.color = "#d84315";
            w.quiz.quiz({
                onMistake: () => { w.status.innerText = "âŒ"; },
                onCorrectStroke: () => { w.status.innerText = "âœ…"; },
                onComplete: () => { w.status.innerText = "ğŸ‰ å®Œç¾"; }
            });
        }
        function resetQuiz(uid) { startQuizLoop(uid); }

        function openRadicalModal(radical) {
            if(!radical || radical === 'ç„¡') return;
            document.getElementById('modal-radical-title').innerText = radical;
            const grid = document.getElementById('modal-grid');
            grid.innerHTML = '';
            
            const matches = HK_COMMON_CHARS.split('').filter(c => {
                try { return cnchar.radical(c)[0].radical === radical; } catch { return false; }
            });
            const uniqueMatches = [...new Set(matches)];

            uniqueMatches.slice(0, 32).forEach(c => {
                const btn = document.createElement('div');
                btn.className = 'radical-char-btn';
                btn.innerText = c;
                btn.onclick = () => { document.getElementById('input-text').value += c; closeRadicalModal(null, true); };
                grid.appendChild(btn);
            });
            document.getElementById('radical-modal').classList.add('open');
        }
        function closeRadicalModal(e, force) {
            if (force || e.target.id === 'radical-modal') document.getElementById('radical-modal').classList.remove('open');
        }

        async function autoPrint() {
            const input = document.getElementById('input-text').value.trim();
            if (!input) { alert("è«‹å…ˆè¼¸å…¥æ–‡å­—"); return; }
            
            const printContent = document.getElementById('print-content');
            printContent.innerHTML = ''; 
            
            const segmenter = new Intl.Segmenter('zh-Hant-HK', { granularity: 'word' });
            const segments = [...segmenter.segment(input)];
            
            for (const seg of segments) {
                const word = seg.segment;
                if (!/[\u4e00-\u9fa5]/.test(word)) continue;

                const row = document.createElement('div');
                row.className = 'print-row';
                
                const mainLine = document.createElement('div');
                mainLine.className = 'print-main-line';
                
                const infoCol = document.createElement('div');
                infoCol.className = 'print-info-col';
                
                const gridContainer = document.createElement('div');
                gridContainer.className = 'print-grid-container';
                gridContainer.innerHTML = '<div class="print-grid-box"></div>'.repeat(8);

                const chars = word.split('');
                for (let i = 0; i < chars.length; i++) {
                    const char = chars[i];
                    const uid = Math.random().toString(36).substr(2, 9);
                    
                    const charBlock = document.createElement('div');
                    charBlock.className = 'print-char-block';
                    charBlock.innerHTML = `
                        <div class="print-char-big" id="p-big-${uid}"></div>
                    `;
                    infoCol.appendChild(charBlock);
                    
                    setTimeout(() => {
                        HanziWriter.create(`p-big-${uid}`, char, { 
                            width: 60, height: 60, showOutline: true, strokeColor: '#000' 
                        });
                    }, 100);
                }
                
                mainLine.appendChild(infoCol);
                mainLine.appendChild(gridContainer);
                row.appendChild(mainLine);

                const breakdownArea = document.createElement('div');
                breakdownArea.className = 'print-breakdown-area';
                
                for (const char of chars) {
                    const breakdownRow = document.createElement('div');
                    breakdownRow.className = 'print-breakdown-row';
                    
                    const label = document.createElement('div');
                    label.className = 'print-label';
                    label.innerText = char + "ï¼š";
                    breakdownRow.appendChild(label);
                    
                    const breakdownImgs = document.createElement('div');
                    breakdownImgs.className = 'print-breakdown-imgs';
                    breakdownRow.appendChild(breakdownImgs);
                    
                    breakdownArea.appendChild(breakdownRow);

                    await generateBreakdown(char, breakdownImgs, true);
                }
                
                row.appendChild(breakdownArea);
                printContent.appendChild(row);
            }

            setTimeout(() => { window.print(); }, 1500);
        }

        function speakText(text, lang) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang; window.speechSynthesis.speak(u);
        }
        
        async function updateDefinition(word, cardElement) {
            const defEl = cardElement.querySelector('.js-def-text');
            try {
                const res = await fetch(`https://www.moedict.tw/a/${encodeURIComponent(word)}.json`);
                if(res.ok) {
                    const data = await res.json();
                    let defs = [];
                    if(data.h) data.h.forEach(h => { if(h.d) h.d.forEach(d => { if(d.f) defs.push(d.f.replace(/[~`\[\]]/g,"")); })});
                    
                    defEl.textContent = defs.length ? defs.map((d,i)=>`${i+1}. ${d}`).join('\n') : "ç„¡è©³ç´°è§£é‡‹";
                } else { defEl.textContent = "æŸ¥ç„¡è³‡æ–™"; }
            } catch { defEl.textContent = "ç„¡è³‡æ–™"; }
        }
    </script>
</body>
</html>
